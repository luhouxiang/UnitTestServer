<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <title>协议测试</title>
    <link rel="stylesheet" href="/static/bootstrap-3.3.7/css/bootstrap.min.css">
	<script src="/static/jquery/jquery-2.1.4.min.js"></script>
    <script src="/static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
	<script>
		$.ajaxSetup({
			data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
		  });
	</script>
</head>
<style type="text/css">
    .mypanel .panel-heading{}
    .mypanel{position: relative;display: none;}
    .opr-btn{position: absolute;right: 200px;}
    .navbar-btn{margin-top:2px;margin-bottom:8px;}
</style>
<body>

<div class="row">
    <div id="panel-box" style="">
        <div class="panel panel-default mypanel" style="margin:10px 30px;">
       <!--
        <span class="opr-btn">
            <button type="button" class="btn btn-default navbar-btn" onclick="btn_add($(this).parent().parent().parent(),$(this).parent().parent())">+</button>
            <button type="button" class="btn btn-default navbar-btn" onclick="btn_sub(this)">-</button>
        </span>
    -->
    	<div class="panel-heading">
    			<span class="btn btn-xs glyphicon glyphicon-plus" onclick="$(this).toggleClass('glyphicon-plus glyphicon-minus').parent().next().toggleClass('hide')"></span><span contenteditable='true'>标题</span>
                <div class="dropdown pull-right" style="display: inline-block;margin-top:-5px">
                    <button type="button" class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">
                        <span class="glyphicon glyphicon-th-list"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation" onclick="btn_save(this)" tabindex="-1" href="#">
                            <a role="menuitem">save</a>
                        </li>
                        <li role="presentation" class="divider"></li>
                        <li role="presentation" onclick="btn_sub(this)">
                            <a role="menuitem" tabindex="-1" href="#">delete</a>
                        </li>
                    </ul>
                </div>
    	</div>
    	<div class="panel-body hide" style="padding-top:1px;">
    		<nav class="navbar navbar-default" >
    			<div class="container-fluid" style="padding-left:0px;padding-bottom:0px;">
    		        <div class="navbar-form navbar-left" style="padding-left: 0px;">

    					<ul class="nav navbar-nav">
    						<li class="dropdown" style="width:82px;"><a href="#" class="dropdown-toggle" data-toggle="dropdown" ><span class="rec_option">GET</span> <b class="caret"></b></a>
    							<ul class="dropdown-menu selectBox">
    								<li><a id="action-get" href="#">GET</a></li>
    								<li class="divider"></li>
    								<li><a id="action-post" href="#">POST</a></li>
    							</ul>
    						</li>
    					</ul>

    		            <div class="form-group">
    		                <input type="text" id="inputurl" class="inputurl" placeholder="Enter request URL" style="width: 626px;margin-top:11px;">
                            <input type="text" id="itemId" class="itemId"  style="margin: 0px 0px 0px 0px; width: 0px; height: 0px; visibility:hidden; ">
                            <input type="text" id="folderId" class="folderId" style="margin: 0px 0px 0px 0px; width: 0px; height: 0px; visibility:hidden; ">
                            <input type="text" id="collectionId" class ="collectionId" style="margin: 0px 0px 0px 0px; width: 0px; height: 0px; visibility:hidden; ">
    		                <button type="button" id="send_btn" class="btn btn-default" onclick="btn_send(this)" style="margin-top:0px;">Send</button>
    		                <button type="button" id="save_btn" class="btn btn-default" onclick="btn_save(this)" style="margin-top:0px;">保存</button>
    		             </div>

    		        </div>
    			</div>
    			<div id="collapseFour" class="panel-collapse collapse">
    				<div class="panel-body" style="padding-top:0px;padding-left:0px; padding-bottom:0px">
    					<textarea rows="10" cols="150" id="rawModeData" class="rawModeData" style="margin: 0px 0px 0px; width: 913px; height: 100px;"></textarea>
    				</div>
    			</div>
    		</nav>
    		Response
    		<nav class="navbar navbar-default">
    			<div class="container-fluid" style="padding-left: 0px;">
    			    <textarea rows="10" cols="150" id="myResponse" class="myResponse" style="margin: 0px 0px 0px; width: 913px; height: 100px;"></textarea>
    			</div>
    		</nav>
    	</div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var Dict = {{ Dict|safe }};
    function BuildTree(dict, folder_dict, tree) {
        var folders = dict['folders']; // folders只针对最外层
        var collectionId = dict["id"];

        tree["collectionId"] = collectionId;
        tree["name"] = folder_dict["name"];

        tree["folderId"] = folder_dict["id"]
        tree["order"] = folder_dict["order"];
        tree["folders"] = [];
        tree["item"] = [];
        for(var i = 0; i < folder_dict["folders_order"].length; i++) {
            for(var j = 0; j < folders.length; j++) {
                if(folder_dict["folders_order"][i] == folders[j].id) {
                    tree["folders"].push({});
                    var folder_len = tree["folders"].length;
                    BuildTree(dict, folders[j], tree["folders"][folder_len-1]);
                }
            }
        }
    }

    function show(ele){
        if(ele.parent().parent().prev().prev().hasClass('glyphicon-plus')){
            ele.parent().parent().prev().prev().trigger('click');
        }
    }

    function BuildItem(dict, folder) {
        folder["item"] = [];
        // console.log("BuildItem: tree: ", folder);
        var request_list = dict['requests'];
        for(var i = 0; i < folder["order"].length; i++) {
            for(var j = 0; j < request_list.length; j++) {
                if(folder["order"][i] == request_list[j].id) {
                     folder["item"].push(request_list[j]);
                }
            }
        }
        for(var i = 0; i < folder["folders"].length; i++) {
            BuildItem(dict, folder["folders"][i]);
        }
    }

	(function(){
	    /*初加载*/
	    var tree_data = {};
        BuildTree(Dict, Dict, tree_data); // 建立节点
        BuildItem(Dict, tree_data);       // 建立叶子
        console.log("tree_data: ", tree_data);
        traversalTree(tree_data, $('#panel-box'))
	})();

    function traversalTree(tree,ele){
        var dropdown = `<div class="dropdown pull-right" style="display: inline-block;">
                        <button type="button" class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">
                            <span class="glyphicon glyphicon-th-list"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                            <li role="presentation" onclick="show($(this));add_folder($(this).parent().parent().parent().parent())" tabindex="-1" href="#">
                                <a role="menuitem">add child folder</a>
                            </li>
                            <li role="presentation" class="divider"></li>
                            <li role="presentation" onclick="show($(this));add_item($(this).parent().parent().parent().parent())">
                                <a role="menuitem" tabindex="-1" href="#">add child item</a>
                            </li>
                            <li role="presentation" class="divider"></li>
                            <li role="presentation" onclick="btn_save()" tabindex="-1" href="#">
                                <a role="menuitem">save</a>
                            </li>
                            <li role="presentation" class="divider"></li>
                            <li role="presentation" onclick="btn_sub(this)">
                                <a role="menuitem" tabindex="-1" href="#">delete</a>
                            </li>
                        </ul>
                    </div>`
        var $div = $('<div></div>');
        $div.attr('style','margin:5px 30px');
		$div.attr('class','panel panel-default');
        ele.append($div)
		var $childrenDiv = $('<div></div>');
		$childrenDiv.attr('class','panel-heading');
		$childrenDiv.attr('style','margin:0');
        var $btn = $('<span></span>');

        $btn.attr('data-folderId', tree.folderId);
        $btn.attr('data-collectionId', tree.collectionId);

        $btn.attr('class','btn glyphicon glyphicon-plus')
        $btn.attr('onclick','$(this).toggleClass("glyphicon-plus glyphicon-minus").parent().nextAll("div").toggleClass("hide")');
        $childrenDiv.append($btn)
        var $span = $('<span></span>');
		$span.attr('contenteditable',true);
        if(tree.name){
            $span.text(tree.name);
        }
        $childrenDiv.append($span);
		$childrenDiv.append(dropdown);
		$div.append($childrenDiv);
        if(tree.item){
            for(var j=0;j<tree.item.length;j++){
                var name = tree.item[j].name;
                var url = tree.item[j].url;
                var method = tree.item[j].method;
                var data = tree.item[j].rawModeData;
                var id = tree.item[j].id;
                btn_add($div, null, tree.item[j])
            }
        }
        if(tree.folders){
            for(var m=0;m<tree.folders.length;m++){
                traversalTree(tree.folders[m],$div)
            }
        }
		$childrenDiv.nextAll("div").addClass("hide");

    }
    function add_folder(ele){
        var dropdown = `<div class="dropdown pull-right" style="display: inline-block;">
                        <button type="button" class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">
                            <span class="glyphicon glyphicon-th-list"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                            <li role="presentation" onclick="show($(this));add_folder($(this).parent().parent().parent().parent())" tabindex="-1" href="#">
                                <a role="menuitem">add child folder</a>
                            </li>
                            <li role="presentation" class="divider"></li>
                            <li role="presentation" onclick="show($(this));add_item($(this).parent().parent().parent().parent())">
                                <a role="menuitem" tabindex="-1" href="#">add child item</a>
                            </li>
                            <li role="presentation" class="divider"></li>
                            <li role="presentation" onclick="btn_save()" tabindex="-1" href="#">
                                <a role="menuitem">save</a>
                            </li>
                            <li role="presentation" class="divider"></li>
                            <li role="presentation" onclick="btn_sub(this)">
                                <a role="menuitem" tabindex="-1" href="#">delete</a>
                            </li>
                        </ul>
                    </div>`
        console.log("add folder...");
        var collectionId = ele.find("[data-collectionId]").attr('data-collectionId');
        var folderId = ele.find("[data-folderId]").attr('data-folderId');
        var $div = $('<div></div>');
        $div.attr('style','margin:5px 30px')
        $div.attr('class','panel panel-default')
        ele.append($div)
        var $childrenDiv = $('<div></div>');
        $childrenDiv.attr('class','panel-heading')
        $childrenDiv.attr('style','margin:0');

        var $btn = $('<span></span>');
        $btn.attr('data-collectionId', collectionId );
        $btn.attr('class','btn glyphicon glyphicon-plus')
        $btn.attr('onclick','$(this).toggleClass("glyphicon-plus glyphicon-minus").parent().nextAll("div").toggleClass("hide")');

        var folderId = $btn.attr('data-folderId');
        console.log("folder: ", folderId);

        $childrenDiv.append($btn)
        var $span = $('<span></span>');
        $span.attr('contenteditable',true);
        $span.text('自定义');

        $childrenDiv.append($span);
        $childrenDiv.append(dropdown);
        $div.append($childrenDiv);
        ele.append($div)

        var jsons = {};
		jsons["name"] = $span.text();
        jsons["folder"] = folderId;
        jsons["collectionId"] = collectionId;

		console.log("jsons: ", JSON.stringify(jsons));

		$.post('/save_new_folder/', {'jsons': JSON.stringify(jsons)}, function(res){
			// responsedata.val(res);
            // toastr.success("保存成功");
            // ShowMsg(res,dom);
            $btn.attr('data-folderId',res);
		});
    }

    let fun_send = btn_send;

    function add_item(container, box){
       var $panel_clone = $('#panel-box>:first').clone(true);
        $panel_clone.show();

        var collectionId = container.find("[data-collectionId]").attr('data-collectionId');
        var folderId = container.find("[data-folderId]").attr('data-folderId');
        var method = $panel_clone.find(".rec_option").text();
        var name = $panel_clone.find('.panel-heading').text();

        console.log("add_item, collectionId:", collectionId);
        console.log("add_item, folderId: ", folderId);

        $panel_clone.find('#collectionId').val(collectionId);
        $panel_clone.find('#folderId').val(folderId);

        $panel_clone.find('#inputurl').next().unbind('click');
        $panel_clone.find('#send_btn').attr('onclick',"fun_send(this)").text('发送')
        if(box){
            box.after($panel_clone);
        }
        else{
            container.append($panel_clone);
        }

        var jsons = {};
		jsons["name"] = name;
		jsons["method"] = method;
        jsons["folder"] = folderId;
        jsons["collectionId"] = collectionId;

		console.log("jsons: ", JSON.stringify(jsons));

		$.post('/save_new_item/', {'jsons': JSON.stringify(jsons)}, function(res){
			// responsedata.val(res);
            // toastr.success("保存成功");
            // ShowMsg(res,dom);
		});

    }


    function btn_add(container, box, item){
       var $panel_clone = $('#panel-box>:first').clone(true);
        $panel_clone.show();

        console.log("item: ", item);

        if(item != null) {
            $panel_clone.children('.panel-heading').children().eq(1).text(item.name)
            $panel_clone.find('.rec_option').text(item.method);
            $panel_clone.find('#itemId').val(item.id);
            $panel_clone.find('#folderId').val(item.folder);
            $panel_clone.find('#collectionId').val(item.collectionId);
            $panel_clone.find('#inputurl').val(item.url);
            $panel_clone.find(".collapse").collapse('show').find('#rawModeData').val(item.rawModeData);
        }

        $panel_clone.find('#inputurl').next().unbind('click');
        $panel_clone.find('#send_btn').attr('onclick',"fun_send(this)").text('发送')
		if(box){
			box.after($panel_clone);
		}
		else{
        	container.append($panel_clone);
		}
        // ele.append($panel_clone);
        // rawModeDataCtl.height(rawModeDataCtl[0].scrollHeight);
    }

	/*删除当前panel*/
	function btn_sub(dom){
	   $(dom).closest('.panel').remove();
	}
    function ShowTip(tip,ele, type) {
        var $tip = $('#tip');
        if ($tip.length == 0) {
            $tip = $('<strong id="tip" style="position:absolute;top:50px;left: 50%;z-index:9999"></strong>');
            $('body').append($tip);
        }
        $tip.stop(true).prop('class', 'alert alert-' + type).text(tip).css({'left': $(ele).offset().left+$(ele).width(),'top':$(ele).offset().top-$(ele).height()*3}).fadeIn(500).delay(2000).fadeOut(500);
    }

    function ShowMsg(msg,ele) {
        ShowTip(msg,ele, 'info');
    }


	// 发送get或post数据，传入底层统一用get
	function btn_send(dom) {
		var $this = $(dom);
        console.log($this.text())
		var $p5 = $this.parent().parent().parent().parent().parent();
		var method = $p5.find(".rec_option").text();
		var url = $p5.find(".inputurl").val();
		var id = $p5.find(".itemId").val();
		console.log("btn_send: id: ", id);
		var rawModeData = $p5.find(".rawModeData").val();
		var responsedata = $p5.find(".myResponse");
		$.post('/send/', {'id': id, 'url': url, 'method':method, 'rawModeData':rawModeData}, function(res){
			responsedata.val(res);
			responsedata.height(responsedata[0].scrollHeight);
		});
	}

    // 发送get或post数据，传入底层统一用get
	function btn_save(dom) {
		var $this = $(dom);
        console.log($this.text())
		var $p5 = $this.parent().parent().parent().parent().parent();
		var method = $p5.find(".rec_option").text();
		var url = $p5.find(".inputurl").val();
		var itemId = $p5.find(".itemId").val();
        var folderId = $p5.find(".folderId").val();
        var collectionId = $p5.find(".collectionId").val();
		var $p6 = $this.parent().parent().parent().parent().parent().parent();
		console.log("p6: ", $p6);
		var name = $p6.find('.panel-heading').text();

        name = name.replace(/[\t]/g,"");//去掉tab
        name = name.replace(/[\r]/g,"");//去掉回车换行
        name = name.replace(/[\n]/g,"");//去掉回车换行
        name = name.replace(/(^\s*)|(\s*$)/g, ""); // 左右两端的空格

		var rawModeData = $p5.find(".rawModeData").val();
		var jsonDatas = {};
		jsonDatas["a"] = "a123";
		jsonDatas["b"] = "b123";

		var jsons = {};
		jsons["name"] = name;
		jsons["id"] = itemId;
        jsons["folder"] = folderId;
        jsons["collectionId"] = collectionId;
		jsons["url"] = url;
		jsons["method"] = method;
		jsons["rawModeData"] = rawModeData;
		console.log("jsons: ", JSON.stringify(jsons));

		var responsedata = $p5.find(".myResponse");
		$.post('/save/', {'jsons': JSON.stringify(jsons)}, function(res){
			// responsedata.val(res);
            // toastr.success("保存成功");
            ShowMsg(res,dom);
		});
	}

	/*添加一个panel*/
    /*删除当前panel*/
    function btn_sub(dom){
       $(dom).parent().parent().remove();
    }

	$(".selectBox").click(function(e){
        var tagName = e.target.tagName;
    	var $this = $(e.target);
    	if(tagName == 'A') {
    		// 根据选择重写菜单栏
    		e.preventDefault();
    		var rec_option = $this.text();
    		var $show_dom = $(this).prev().find(".rec_option");
    		$show_dom.text(rec_option);

    		// 根据选择的是否为POST决定是否显示PostData输入项
    		var myparent = $(this).closest('.mypanel');
    		if($this.text() == "GET") {
                myparent.children('.panel-heading').html('此处GET自定义标题');
                myparent.find('#inputurl').val('此处GET自定义url')
    			myparent.find(".collapse").collapse('hide');
    		}
    		else {
                myparent.children('.panel-heading').html('此处POST自定义标题');
                myparent.find('#inputurl').val('此处POST自定义url')
    			myparent.find(".collapse").collapse('show').find('#rawModeData').text('post发送时预先加载的数据');
    		}
    	}
    });

</script>
</body>
</html>
